<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Mini Game IELTS - ƒêƒÉng k√Ω nh·∫≠n qu√† üéÅ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- GSAP for animations -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js" defer></script>
  <!-- Confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js" defer></script>

  <style>
    :root {
      --bg-gradient: linear-gradient(135deg, #ffe5f1, #e0f2ff);
      --card-bg: #ffffff;
      --primary: #ff69b4;
      --primary-dark: #f04494;
      --accent: #7c3aed;
      --text-main: #222;
      --text-muted: #666;
      --border-radius-lg: 24px;
      --shadow-soft: 0 18px 45px rgba(0, 0, 0, 0.3);
    }

    * { box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; margin: 0; padding: 0; }
    body { min-height: 100vh; background: var(--bg-gradient); display: flex; align-items: center; justify-content: center; padding: 16px; color: var(--text-main); }
    .app { width: 100%; max-width: 480px; }
    .card { background: var(--card-bg); border-radius: var(--border-radius-lg); box-shadow: var(--shadow-soft); overflow: hidden; position: relative; }
    .card-inner { padding: 20px 20px 24px; }

    .intro { position: relative; height: 500px; overflow: hidden; display: flex; justify-content: center; align-items: center; }
    .intro img { width: 100%; height: 100%; object-fit: contain; transform-origin: center center; transform: translateX(13px) translateY(17px); max-width: 350px; }
    .intro-overlay { position: absolute; inset: 0; background: linear-gradient(to top, rgba(0, 0, 0, 0), transparent); display: flex; flex-direction: column; justify-content: space-between; padding: 16px 20px; color: #fff; align-items: center; }
    .intro-title { font-size: 23px; font-weight: 700; line-height: 1.3; color: red; text-align: center; margin-top: 6px; display: flex; flex-direction: column; }
    .intro-cta { display: inline-flex; align-items: center; background: red; color: white; border-radius: 999px; padding: 6px 14px; font-size: 18px; font-weight: 600; cursor: pointer; border: none; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); transition: transform 0.15s ease, box-shadow 0.15s ease; margin-bottom: 15px; }
    .intro-cta span { margin-left: 12px; transform: scale(1.4); }
    .intro-cta:hover { transform: translateY(-1px); box-shadow: 0 14px 35px rgba(0,0,0,0.28); }
    .intro-cta:active { transform: translateY(1px) scale(0.98); box-shadow: 0 8px 18px rgba(0,0,0,0.18); }

    .stepper { display: flex; justify-content: center; margin-bottom: 12px; margin-top: 8px; gap: 6px; }
    .step-dot { width: 8px; height: 8px; border-radius: 50%; background: #e5e7eb; position: relative; }
    .step-dot.active { background: var(--primary); transform: scale(1.2); }
    .step-dot.completed::after { content: ""; position: absolute; inset: -3px; border-radius: 999px; border: 2px solid rgba(255, 105, 180, 0.4); }

    .question-tag { display: inline-flex; align-items: center; gap: 6px; font-size: 11px; padding: 4px 8px; border-radius: 999px; background: #f1f5f9; color: #0f172a; margin-bottom: 6px; }
    .question-title { font-size: 17px; font-weight: 700; margin-bottom: 15px; }
    .question-desc { font-size: 13px; color: var(--text-muted); margin-bottom: 12px; }
    .field { margin-bottom: 16px; }
    .input-text { width: 100%; border-radius: 999px; border: 1px solid #e5e7eb; padding: 10px 14px; font-size: 14px; outline: none; transition: border-color 0.15s ease, box-shadow 0.15s ease; background: #f9fafb; }
    .input-text:focus { border-color: var(--primary); box-shadow: 0 0 0 1px rgba(255, 105, 180, 0.28); background: #fff; }
    .error-text { font-size: 12px; color: #dc2626; margin-top: 8px; }

    .radio-group, .checkbox-group { display: flex; flex-direction: column; gap: 8px; }
    .chip { display: inline-flex; align-items: center; gap: 8px; border-radius: 999px; padding: 8px 12px; border: 1px solid #e5e7eb; background: #f9fafb; cursor: pointer; font-size: 13px; transition: background 0.15s ease, border-color 0.15s ease, transform 0.1s ease; }
    .chip span.icon { font-size: 16px; }
    .chip.active { background: #fdf2ff; border-color: var(--primary); box-shadow: 0 0 0 1px rgba(255,105,180,0.16); transform: translateY(-1px); }
    .chip-label-text { display: flex; flex-direction: column; gap: 1px; }
    .chip-title { font-weight: 600; }
    .actions { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; gap: 12px; }

    .btn { border-radius: 999px; border: none; padding: 10px 18px; font-size: 14px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 6px; transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.1s ease; white-space: nowrap; }
    .btn-primary { background: var(--primary); color: #fff; box-shadow: 0 12px 30px rgba(255,105,180,0.35); }
    .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); box-shadow: 0 16px 40px rgba(255,105,180,0.45); }
    .btn-primary:active { transform: translateY(1px) scale(0.98); box-shadow: 0 8px 22px rgba(255,105,180,0.25); }
    .btn-ghost { background: transparent; color: var(--text-muted); padding-inline: 6px; box-shadow: none; }
    .btn-ghost:hover { color: var(--text-main); transform: translateY(-1px); }

    .success-screen { text-align: center; padding: 20px 10px 6px; }
    .success-badge { display: inline-flex; align-items: center; gap: 6px; padding: 5px 10px; border-radius: 999px; background: #ecfdf5; color: #166534; font-size: 12px; margin-bottom: 8px; }
    .success-emoji { font-size: 40px; margin-bottom: 8px; }
    .success-title { font-size: 18px; font-weight: 700; margin-bottom: 6px; }
    .success-text { font-size: 13px; color: var(--text-muted); margin-bottom: 4px; }
    .tiny-footer { margin-top: 10px; font-size: 10px; color: #9ca3af; text-align: center; }
    .music-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--primary);
      color: #fff;
      width: 52px;
      height: 52px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
      font-size: 24px;
      z-index: 100;
      transition: transform .15s ease, background .25s ease;
      user-select: none;
    }
    .music-btn.playing { background: var(--accent); }
    .music-btn:hover { transform: scale(1.07); }
 </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <div class="intro" id="intro-section">
        <!-- <img id="school-image" src="https://dongphucgiadinh.com/wp-content/uploads/2022/09/dong-phuc-truong-vo-van-kiet-8.jpg" alt="Tr∆∞·ªùng THPT" /> -->
        <img id="school-image" src="https://cf.shopee.vn/file/1a9787a23c14356e4a6f9ef329944285" alt="Tr∆∞·ªùng THPT" />

        <div class="intro-overlay">
          <div class="intro-title">
            Nh·∫≠n qu√† si√™u x·ªãn c√πng 
            <span> üéÅ IELTS FIGHTER üéÅ </span>
          </div>
          <button class="intro-cta" id="start-btn">B·∫Øt ƒë·∫ßu ngay <span>üëâ</span></button>
        </div>
      </div>

      <div class="card-inner" id="form-section" style="display:none;">
        <div class="stepper" id="stepper"></div>
        <div id="step-container"></div>
        <div class="actions">
          <button class="btn btn-ghost" id="prev-btn" style="visibility:hidden;">‚¨Ö Quay l·∫°i</button>
          <div style="flex:1;"></div>
          <button class="btn btn-primary" id="next-btn">Ti·∫øp t·ª•c ‚ûú</button>
        </div>
        <div class="tiny-footer">
          üí° Th√¥ng tin ch·ªâ d√πng cho ch∆∞∆°ng tr√¨nh t∆∞ v·∫•n h·ªçc t·∫≠p & ∆∞u ƒë√£i IELTS. Kh√¥ng spam, kh√¥ng chia s·∫ª ra ngo√†i.
        </div>
      </div>

      <div class="card-inner" id="success-section" style="display:none;">
        <div class="success-screen">
          <div class="success-emoji">ü©∑</div>
          <div class="success-title">Ho√†n t·∫•t r·ªìi, c·∫£m ∆°n b·∫°n! üéâ</div>
          <p class="success-text">
            Th·∫ßy/c√¥ b√™n trung t√¢m s·∫Ω d·ª±a v√†o th√¥ng tin b·∫°n ch·ªçn ƒë·ªÉ g·ª≠i ƒë√∫ng qu√†:
            t√†i li·ªáu, mini test ho·∫∑c bu·ªïi h·ªçc th·ª≠ ph√π h·ª£p.
          </p>
          <div class="success-badge" id="success-extra-badge">
            <span>üì±</span> Nh·ªõ gi·ªØ ƒëi·ªán tho·∫°i ƒë·ªÉ nh·∫≠n qu√† tr√™n Zalo nha.
          </div>
          <button class="btn btn-primary" id="restart-btn" style="margin-top:12px;">G·ª≠i th√™m cho b·∫°n kh√°c üëØ</button>
        </div>
      </div>
    </div>
  </div>

  <div id="music-toggle" class="music-btn" title="Nh·∫°c n·ªÅn">üéµ</div>
  <audio id="bg-audio" preload="auto" loop>
    <source src="assets/music.mp3" type="audio/mpeg" />
  </audio>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzulNomDfWL7zDbB-XguK_o7pXRbU_jLw-YjnHDEvDme0qH5LvclNdRDozujNSNJ7u9_g/exec";
    const TOTAL_STEPS = 5;

    const state = {
      currentStep: 1,
      name: "",
      phone: "",
      goal: "",
      freebies: [],
      referral: "",
      school: "",
      notes: "",
      isSubmitting: false,
    };

    // ==== VALIDATION HELPERS (T√™n & SƒêT Vi·ªát Nam) ====
    function sanitizeName(raw) {
      return raw
        .replace(/[^A-Za-z√Ä-·ª∏√†-·ªπƒÇƒÉ√Ç√¢√ä√™√î√¥∆†∆°∆Ø∆∞ƒêƒë\s]/gu, "")
        .replace(/\s+/g, " ")
        .trim();
    }

    function isValidVietnameseName(name) {
  if (!name) return false;

  // X·ª≠ l√Ω kho·∫£ng tr·∫Øng
  const cleaned = name.trim().replace(/\s+/g, " ");

  // √çt nh·∫•t 2 k√Ω t·ª±
  if (cleaned.length < 2 || cleaned.length > 50) return false;

  // √çt nh·∫•t 2 t·ª´ (tr√°nh t√™n 1 ch·ªØ d·∫°ng "a", "b")
  const words = cleaned.split(" ");
  if (words.length < 1) return false;

  // Regex ch·∫•p nh·∫≠n c·∫£ c√≥ d·∫•u & kh√¥ng d·∫•u
  const pattern =
    /^[A-Za-z√Ä-·ª∏√†-·ªπƒÇƒÉ√Ç√¢√ä√™√î√¥∆†∆°∆Ø∆∞ƒêƒë]+( [A-Za-z√Ä-·ª∏√†-·ªπƒÇƒÉ√Ç√¢√ä√™√î√¥∆†∆°∆Ø∆∞ƒêƒë]+)*$/u;

  return pattern.test(cleaned);
}



    function cleanPhone(raw) {
      return raw
        .replace(/[^\d+]/g, "")
        .replace(/^(\+84)/, "0")
        .replace(/^00+84/, "0")
        .trim();
    }

    function isValidVietnamesePhone(raw) {
      const p = cleanPhone(raw);
      return /^(0)(3|5|7|8|9)\d{8}$/.test(p);
    }

    document.addEventListener("DOMContentLoaded", () => {
      const startBtn = document.getElementById("start-btn");
      const introSection = document.getElementById("intro-section");
      const formSection = document.getElementById("form-section");
      const successSection = document.getElementById("success-section");
      const restartBtn = document.getElementById("restart-btn");

      renderStepper();
      renderStep();

      startBtn.addEventListener("click", () => {
        animateIntroOut(() => {
          introSection.style.display = "none";
          formSection.style.display = "block";
          animateFormIn();
        });
      });

      document.getElementById("next-btn").addEventListener("click", handleNext);
      document.getElementById("prev-btn").addEventListener("click", handlePrev);

      restartBtn.addEventListener("click", () => {
        state.currentStep = 1;
        state.name = "";
        state.phone = "";
        state.goal = "";
        state.freebies = [];
        state.referral = "";
        state.isSubmitting = false;
        document.getElementById("step-container").innerHTML = "";
        renderStepper();
        renderStep();
        successSection.style.display = "none";
        formSection.style.display = "block";
        animateFormIn();
      });
    });

    function animateIntroOut(onComplete) {
      const img = document.getElementById("school-image");
      const overlay = document.querySelector(".intro-overlay");
      if (window.gsap) {
        gsap.to(img, { scale: 1.2, opacity: 0, duration: 0.6, ease: "power2.inOut" });
        gsap.to(overlay, { y: 30, opacity: 0, duration: 0.5, ease: "power2.inOut", onComplete });
      } else onComplete();
    }

    function animateFormIn() {
      const formSection = document.getElementById("form-section");
      if (window.gsap) {
        gsap.fromTo(formSection, { opacity: 0, y: 20 }, { opacity: 1, y: 0, duration: 0.45, ease: "power2.out" });
      }
    }

    function animateStepChange() {
      const stepContainer = document.getElementById("step-container");
      if (window.gsap) {
        gsap.fromTo(stepContainer, { opacity: 0, y: 10 }, { opacity: 1, y: 0, duration: 0.3, ease: "power2.out" });
      }
    }

    function fireSuccessConfetti() {
      if (window.confetti) {
        const duration = 1500;
        const end = Date.now() + duration;
        (function frame() {
          confetti({ particleCount: 4, angle: 60, spread: 55, origin: { x: 0 } });
          confetti({ particleCount: 4, angle: 120, spread: 55, origin: { x: 1 } });
          if (Date.now() < end) requestAnimationFrame(frame);
        })();
      }
    }

    function renderStepper() {
      const stepper = document.getElementById("stepper");
      stepper.innerHTML = "";
      for (let i = 1; i <= TOTAL_STEPS; i++) {
        const dot = document.createElement("div");
        dot.className = "step-dot";
        if (i === state.currentStep) dot.classList.add("active");
        else if (i < state.currentStep) dot.classList.add("completed");
        stepper.appendChild(dot);
      }
    }

    function renderStep(errorMsg) {
      const container = document.getElementById("step-container");
      container.innerHTML = "";
      const wrapper = document.createElement("div");

      const qTag = document.createElement("div");
      qTag.className = "question-tag";
      qTag.innerHTML = `‚ú® C√¢u h·ªèi ${state.currentStep}/${TOTAL_STEPS}`;
      wrapper.appendChild(qTag);

      let title = "", desc = "";

      if (state.currentStep === 1) {
        title = "1) T√™n c·ªßa b·∫°n l√† g√¨? üßë‚Äçüéì";
        desc = "";
        wrapper.appendChild(renderQuestionHeader(title, desc));

        const field = document.createElement("div");
        field.className = "field";

        const input = document.createElement("input");
        input.type = "text";
        input.className = "input-text";
        input.placeholder = "VD: Nguy·ªÖn Minh Anh";
        input.value = state.name;
        input.autocomplete = "name";
        input.addEventListener("input", e => { state.name = e.target.value; });
        input.addEventListener("blur", () => {
          input.value = sanitizeName(input.value);
          state.name = input.value;
        });

        field.appendChild(input);
        if (errorMsg) field.appendChild(renderError(errorMsg));
        wrapper.appendChild(field);
      }

      if (state.currentStep === 2) {
        title = "2) S·ªë ƒëi·ªán tho·∫°i ?";
        desc = "ƒê·ªÉ g·ª≠i b·ªô t√†i li·ªáu IELTS + mini test sau ch∆∞∆°ng tr√¨nh nha ‚ù§Ô∏è";
        wrapper.appendChild(renderQuestionHeader(title, desc));

        const field = document.createElement("div");
        field.className = "field";

        const input = document.createElement("input");
        input.type = "tel";
        input.className = "input-text";
        input.placeholder = "VD: 0901 234 567";
        input.value = state.phone;
        input.autocomplete = "tel";
        input.addEventListener("input", e => { state.phone = e.target.value; });
        input.addEventListener("blur", () => {
          input.value = cleanPhone(input.value);
          state.phone = input.value;
        });

        field.appendChild(input);
        if (errorMsg) field.appendChild(renderError(errorMsg));
        else {
          const hint = document.createElement("div");
          hint.className = "error-text";
          hint.style.color = "#6b7280";
          hint.textContent = "L∆∞u √Ω: ∆∞u ti√™n s·ªë ƒëang d√πng Zalo nh√©.";
          field.appendChild(hint);
        }
        wrapper.appendChild(field);
      }

      if (state.currentStep === 3) {
        title = "3) B·∫°n c√≥ m·ª•c ti√™u h·ªçc IELTS kh√¥ng? üéØ";
        desc = "";
        wrapper.appendChild(renderQuestionHeader(title, desc));

        const group = document.createElement("div");
        group.className = "radio-group";
        const options = [
          { value: "co_chac_chan", icon: "üî•", title: "C√≥" },
          { value: "co_dang_suy_nghi", icon: "üí≠", title: "ƒêang suy nghƒ©" },
          { value: "khong", icon: "üôÖ‚Äç‚ôÄÔ∏è", title: "Kh√¥ng" },
        ];

        options.forEach(opt => {
          const label = document.createElement("label");
          label.className = "chip";
          if (state.goal === opt.value) label.classList.add("active");
          label.innerHTML = `
            <span class="icon">${opt.icon}</span>
            <div class="chip-label-text">
              <span class="chip-title">${opt.title}</span>
            </div>
          `;
          label.addEventListener("click", () => {
            state.goal = opt.value;
            renderStep();
            renderStepper();
          });
          group.appendChild(label);
        });

        if (errorMsg) group.appendChild(renderError(errorMsg));
        wrapper.appendChild(group);
      }

      if (state.currentStep === 4) {
        title = "4) H√¥m nay b·∫°n mu·ªën nh·∫≠n g√¨ mi·ªÖn ph√≠? üéÅ";
        desc = "C√≥ th·ªÉ ch·ªçn nhi·ªÅu m·ª•c c√πng l√∫c nha.";
        wrapper.appendChild(renderQuestionHeader(title, desc));

        const group = document.createElement("div");
        group.className = "checkbox-group";
        const options = [
          { value: "tai_lieu", icon: "üìö", title: "B·ªô t√†i li·ªáu IELTS" },
            { value: "test_nang_luc", icon: "üìù", title: "Test nƒÉng l·ª±c" },
            { value: "hoc_thu", icon: "üéß", title: "1 bu·ªïi h·ªçc th·ª≠" },
            { value: "voucher", icon: "üé´", title: "Voucher 5 tri·ªáu" },
            { value: "xem_thu", icon: "üëÄ", title: "Ch·ªâ v√¨ qu√† mini game n√†y" },
        ];
        options.forEach(opt => {
          const label = document.createElement("label");
            label.className = "chip";
            if (state.freebies.includes(opt.value)) label.classList.add("active");
            label.innerHTML = `
            <span class="icon">${opt.icon}</span>
            <div class="chip-label-text">
              <span class="chip-title">${opt.title}</span>
            </div>
          `;
            label.addEventListener("click", () => {
              toggleFreebie(opt.value);
              renderStep();
            });
            group.appendChild(label);
        });
        wrapper.appendChild(group);
      }

      if (state.currentStep === 5) {
        title = "B·∫°n c√≥ mu·ªën nh·∫≠n th∆∞·ªüng 500.000ƒë cho m·ªói ng∆∞·ªùi b·∫°n gi·ªõi thi·ªáu c√πng h·ªçc IELTS kh√¥ng? üí∏";
        desc = "";
        wrapper.appendChild(renderQuestionHeader(title, desc));

        const group = document.createElement("div");
        group.className = "radio-group";
        const options = [
          { value: "yes", icon: "üòç", title: "C√≥ ch·ª©, nghe h·∫•p d·∫´n ƒë√≥!" },
          { value: "no", icon: "üòÖ", title: "ch∆∞a, ƒë·ªÉ xem ƒë√£..." },
        ];
        options.forEach(opt => {
          const label = document.createElement("label");
          label.className = "chip";
          if (state.referral === opt.value) label.classList.add("active");
          label.innerHTML = `
            <span class="icon">${opt.icon}</span>
            <div class="chip-label-text">
              <span class="chip-title">${opt.title}</span>
            </div>
          `;
          label.addEventListener("click", () => {
            state.referral = opt.value;
            renderStep();
          });
          group.appendChild(label);
        });
        if (errorMsg) group.appendChild(renderError(errorMsg));
        wrapper.appendChild(group);
      }

      container.appendChild(wrapper);
      animateStepChange();

      const prevBtn = document.getElementById("prev-btn");
      const nextBtn = document.getElementById("next-btn");
      prevBtn.style.visibility = state.currentStep === 1 ? "hidden" : "visible";
      nextBtn.textContent = state.currentStep === TOTAL_STEPS ? "G·ª≠i th√¥ng tin ‚úÖ" : "Ti·∫øp t·ª•c ‚ûú";
    }

    function renderQuestionHeader(title, desc) {
      const frag = document.createElement("div");
      const h = document.createElement("div");
      h.className = "question-title";
      h.textContent = title;
      const p = document.createElement("div");
      p.className = "question-desc";
      p.textContent = desc;
      frag.appendChild(h);
      frag.appendChild(p);
      return frag;
    }

    function renderError(msg) {
      const err = document.createElement("div");
      err.className = "error-text";
      err.textContent = msg;
      return err;
    }

    function toggleFreebie(value) {
      const idx = state.freebies.indexOf(value);
      if (idx === -1) state.freebies.push(value);
      else state.freebies.splice(idx, 1);
    }

    function handleNext() {
      const error = validateCurrentStep();
      if (error) {
        renderStep(error);
        return;
      }
      if (state.currentStep === TOTAL_STEPS) {
        submitForm();
        return;
      }
      state.currentStep++;
      renderStepper();
      renderStep();
    }

    function handlePrev() {
      if (state.currentStep === 1) return;
      state.currentStep--;
      renderStepper();
      renderStep();
    }

    function validateCurrentStep() {
      if (state.currentStep === 1) {
        if (!state.name.trim()) return "B·∫°n vui l√≤ng cho t·ª•i m√¨nh bi·∫øt t√™n nh√©.";
        if (!isValidVietnameseName(state.name)) return "T√™n ch∆∞a h·ª£p l·ªá. D√πng t√™n ti·∫øng Vi·ªát, kh√¥ng s·ªë/k√Ω t·ª± l·∫°.";
        state.name = sanitizeName(state.name);
      }
      if (state.currentStep === 2) {
        if (!state.phone.trim()) return "B·∫°n vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i/Zalo nh√©.";
        if (!isValidVietnamesePhone(state.phone)) return "Cho s·ªë b·∫≠y kh√¥ng ƒë∆∞·ª£c nh·∫≠n qu√† nha n√≠ ";
        state.phone = cleanPhone(state.phone);
      }
      if (state.currentStep === 3) {
        if (!state.goal) return "B·∫°n ch·ªçn gi√∫p t·ª•i m√¨nh 1 ƒë√°p √°n nha.";
      }
      if (state.currentStep === 5) {
        if (!state.referral && state.goal !== "khong") {
          return "B·∫°n ch·ªçn 1 ƒë√°p √°n ƒë·ªÉ t·ª•i m√¨nh d·ªÖ t∆∞ v·∫•n h∆°n nh√©.";
        }
      }
      return null;
    }

    function submitForm() {
      if (state.isSubmitting) return;
      state.isSubmitting = true;
      const nextBtn = document.getElementById("next-btn");
      nextBtn.disabled = true;
      nextBtn.textContent = "ƒêang g·ª≠i...";

      const payload = {
        name: state.name.trim(),
        phone: state.phone.replace(/\s+/g, ""),
        goal: state.goal,
        freebies: JSON.stringify(state.freebies),
        referral: state.referral,
        school: state.school || "",
        notes: state.notes || "",
      };

      const formData = new URLSearchParams(payload);

      fetch(API_URL, { method: "POST", body: formData })
        .then(res => res.json())
        .then(data => {
          const formSection = document.getElementById("form-section");
          const successSection = document.getElementById("success-section");
          if (data.status === "ok") {
            formSection.style.display = "none";
            successSection.style.display = "block";
            fireSuccessConfetti();
          } else if (data.status === "duplicate") {
            state.isSubmitting = false;
            nextBtn.disabled = false;
            nextBtn.textContent = "G·ª≠i th√¥ng tin ‚úÖ";
            alert("S·ªë ƒëi·ªán tho·∫°i n√†y ƒë√£ ƒë∆∞·ª£c ƒëƒÉng k√Ω r·ªìi nha. B·∫°n th·ª≠ s·ªë kh√°c ho·∫∑c ki·ªÉm tra l·∫°i.");
          } else {
            state.isSubmitting = false;
            nextBtn.disabled = false;
            nextBtn.textContent = "G·ª≠i th√¥ng tin ‚úÖ";
            alert("C√≥ l·ªói x·∫£y ra. B·∫°n th·ª≠ l·∫°i gi√∫p t·ª•i m√¨nh nh√©!");
          }
        })
        .catch(err => {
          console.error(err);
          state.isSubmitting = false;
          nextBtn.disabled = false;
          nextBtn.textContent = "G·ª≠i th√¥ng tin ‚úÖ";
          alert("Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c. B·∫°n ki·ªÉm tra m·∫°ng ho·∫∑c b√°o cho th·∫ßy/c√¥ nha.");
        });
    }

   document.addEventListener("DOMContentLoaded", () => {
      // ...existing code...
      const musicToggle = document.getElementById("music-toggle");
      const bgAudio = document.getElementById("bg-audio");
      let musicStarted = false;

      function safePlay() {
        bgAudio.volume = 0.55;
        bgAudio.play()
          .then(() => {
            musicStarted = true;
            musicToggle.classList.add("playing");
          })
          .catch(() => {});
      }

      // Try autoplay immediately, fall back to first user interaction if blocked
      function attemptAutoPlay() {
        bgAudio.volume = 0.55;
        bgAudio.play()
          .then(() => {
            musicStarted = true;
            musicToggle.classList.add("playing");
          })
          .catch(() => {
            const startOnFirstInteraction = () => {
              if (!musicStarted) safePlay();
            };
            window.addEventListener("pointerdown", startOnFirstInteraction, { once: true });
            window.addEventListener("keydown", startOnFirstInteraction, { once: true });
            window.addEventListener("touchstart", startOnFirstInteraction, { once: true });
          });
      }
      attemptAutoPlay();

      musicToggle.addEventListener("click", () => {
        if (!musicStarted) {
          safePlay();
          return;
        }
        if (bgAudio.paused) {
          bgAudio.play().then(() => musicToggle.classList.add("playing"));
        } else {
          bgAudio.pause();
          musicToggle.classList.remove("playing");
        }
      });

      const startBtn = document.getElementById("start-btn");
      startBtn.addEventListener("click", () => {
        if (!musicStarted) safePlay();
      });
    });
  
  
  </script>
</body>
</html>